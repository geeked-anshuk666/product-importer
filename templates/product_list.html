{% extends 'base.html' %}

{% block title %}Product Importer - Products{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="page-title">Product Management</h1>
    
    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3><i class="bi bi-tags"></i> Products</h3>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" data-mode="create">
                        <i class="bi bi-plus-circle"></i> Add Product
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <form id="filterForm" class="row g-3">
                                <div class="col-md-3">
                                    <label for="skuFilter" class="form-label">SKU</label>
                                    <input type="text" class="form-control" id="skuFilter" placeholder="Filter by SKU">
                                </div>
                                <div class="col-md-3">
                                    <label for="nameFilter" class="form-label">Name</label>
                                    <input type="text" class="form-control" id="nameFilter" placeholder="Filter by name">
                                </div>
                                <div class="col-md-3">
                                    <label for="activeFilter" class="form-label">Active Status</label>
                                    <select class="form-control" id="activeFilter">
                                        <option value="">All</option>
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">&nbsp;</label>
                                    <div>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-funnel"></i> Filter
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="clearFilters">
                                            <i class="bi bi-x-circle"></i> Clear
                                        </button>
                                        <button type="button" class="btn btn-danger" id="bulkDeleteBtn">
                                            <i class="bi bi-trash"></i> Delete All
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>SKU</th>
                                    <th>Name</th>
                                    <th>Description</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="productsTableBody">
                                <!-- Products will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                    
                    <nav aria-label="Product pagination">
                        <ul class="pagination justify-content-center" id="pagination">
                            <!-- Pagination will be loaded here -->
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1" aria-labelledby="productModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalLabel">Add Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productSku" class="form-label">SKU *</label>
                        <input type="text" class="form-control" id="productSku" required>
                    </div>
                    <div class="mb-3">
                        <label for="productName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="productActive" checked>
                        <label class="form-check-label" for="productActive">Active</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="saveProductBtn">
                    <i class="bi bi-save"></i> Save Product
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="bi bi-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Delete Confirmation Modal -->
<div class="modal fade" id="bulkDeleteModal" tabindex="-1" aria-labelledby="bulkDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bulkDeleteModalLabel">Confirm Bulk Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete ALL products?</p>
                <p class="text-danger">This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancel
                </button>
                <button type="button" class="btn btn-danger" id="confirmBulkDeleteBtn">
                    <i class="bi bi-trash"></i> Delete All
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentProductId = null;
    
    $(document).ready(function() {
        // Load products on page load
        loadProducts();
        
        // Handle filter form submission
        $('#filterForm').on('submit', function(e) {
            e.preventDefault();
            loadProducts();
        });
        
        // Handle clear filters
        $('#clearFilters').on('click', function() {
            $('#skuFilter').val('');
            $('#nameFilter').val('');
            $('#activeFilter').val('');
            loadProducts();
        });
        
        // Handle product modal
        $('#productModal').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            const mode = button.data('mode');
            const productId = button.data('product-id');
            
            const modal = $(this);
            if (mode === 'edit' && productId) {
                currentProductId = productId;
                modal.find('.modal-title').text('Edit Product');
                
                // Load product data
                $.get(`/api/products/${productId}/`, function(data) {
                    $('#productSku').val(data.sku);
                    $('#productName').val(data.name);
                    $('#productDescription').val(data.description);
                    $('#productActive').prop('checked', data.is_active);
                });
            } else {
                currentProductId = null;
                modal.find('.modal-title').text('Add Product');
                $('#productForm')[0].reset();
            }
        });
        
        // Handle delete modal
        $('#deleteModal').on('show.bs.modal', function(event) {
            const button = $(event.relatedTarget);
            currentProductId = button.data('product-id');
        });
        
        // Handle save product
        $('#saveProductBtn').on('click', function() {
            const sku = $('#productSku').val();
            const name = $('#productName').val();
            const description = $('#productDescription').val();
            const is_active = $('#productActive').is(':checked');
            
            if (!sku || !name) {
                alert('SKU and Name are required fields.');
                return;
            }
            
            const productData = {
                sku: sku,
                name: name,
                description: description,
                is_active: is_active
            };
            
            let method = 'POST';
            let urlEndpoint = '/api/products/';
            
            if (currentProductId) {
                method = 'PUT';
                urlEndpoint = `/api/products/${currentProductId}/`;
            }
            
            $.ajax({
                url: urlEndpoint,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(productData),
                success: function(data) {
                    $('#productModal').modal('hide');
                    loadProducts();
                    alert('Product saved successfully!');
                },
                error: function(xhr) {
                    alert('Error saving product: ' + xhr.responseText);
                }
            });
        });
        
        // Handle delete product
        $('#confirmDeleteBtn').on('click', function() {
            if (currentProductId) {
                const productIdToDelete = currentProductId; // Store for potential error handling
                $.ajax({
                    url: `/api/products/${currentProductId}/`,
                    method: 'DELETE',
                    success: function() {
                        $('#deleteModal').modal('hide');
                        alert('Product deleted successfully!');
                        loadProducts();
                    },
                    error: function(xhr) {
                        $('#deleteModal').modal('hide');
                        if (xhr.status === 404) {
                            alert('Product not found. It may have already been deleted.');
                            // Remove the row from the table directly
                            $(`button[data-product-id="${productIdToDelete}"]`).closest('tr').fadeOut(300, function() {
                                $(this).remove();
                                // Check if table is empty and show "No products found" message
                                if ($('#productsTableBody tr').length === 0) {
                                    loadProducts(); // Reload to show proper pagination
                                }
                            });
                        } else {
                            alert('Error deleting product: ' + xhr.responseText);
                        }
                    }
                });
            } else {
                alert('No product selected for deletion.');
                $('#deleteModal').modal('hide');
            }
        });
        
        // Handle bulk delete
        $('#bulkDeleteBtn').on('click', function() {
            $('#bulkDeleteModal').modal('show');
        });
        
        $('#confirmBulkDeleteBtn').on('click', function() {
            // Check if there are any products to delete
            $.get('/api/products/', function(data) {
                const products = data.results || data;
                if (!products || products.length === 0) {
                    $('#bulkDeleteModal').modal('hide');
                    alert('No products available to delete.');
                    return;
                }
                
                // Proceed with deletion if products exist
                $.ajax({
                    url: '/api/products/bulk-delete/',
                    method: 'DELETE',
                    success: function() {
                        $('#bulkDeleteModal').modal('hide');
                        alert('All products deleted successfully!');
                        loadProducts();
                    },
                    error: function(xhr) {
                        $('#bulkDeleteModal').modal('hide');
                        alert('Error deleting products: ' + xhr.responseText);
                    }
                });
            }).fail(function(xhr) {
                $('#bulkDeleteModal').modal('hide');
                alert('Error checking products: ' + xhr.responseText);
            });
        });
        
        // Load products function
        function loadProducts(page = 1) {
            // Ensure page is a valid number
            const pageNumber = parseInt(page) || 1;
            console.log('Loading products for page:', pageNumber);
            
            const sku = $('#skuFilter').val();
            const name = $('#nameFilter').val();
            const is_active = $('#activeFilter').val();
            
            let url = `/api/products/?page=${pageNumber}`;
            console.log('API URL:', url);
            if (sku) url += `&sku=${encodeURIComponent(sku)}`;
            if (name) url += `&name=${encodeURIComponent(name)}`;
            if (is_active) url += `&is_active=${is_active}`;
            
            $.get(url, function(data) {
                const tbody = $('#productsTableBody');
                tbody.empty();
                
                try {
                    // Handle both paginated and non-paginated responses
                    const products = data.results || data;
                    
                    if (products && products.length > 0) {
                        products.forEach(function(product) {
                            const status = product.is_active ? 'Active' : 'Inactive';
                            const statusClass = product.is_active ? 'text-success' : 'text-danger';
                            
                            const row = `
                                <tr>
                                    <td>${product.sku}</td>
                                    <td>${product.name}</td>
                                    <td>${product.description || ''}</td>
                                    <td><span class="${statusClass}">${status}</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#productModal" 
                                                data-mode="edit" 
                                                data-product-id="${product.id}">
                                            <i class="bi bi-pencil"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                data-bs-toggle="modal" 
                                                data-bs-target="#deleteModal" 
                                                data-product-id="${product.id}">
                                            <i class="bi bi-trash"></i> Delete
                                        </button>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                        
                        // Update pagination
                        updatePagination(data);
                    } else {
                        tbody.append('<tr><td colspan="5" class="text-center">No products found</td></tr>');
                        $('#pagination').empty();
                    }
                } catch (error) {
                    console.error('Error processing products data:', error);
                    tbody.append('<tr><td colspan="5" class="text-center text-danger">Error loading products</td></tr>');
                }
            }).fail(function(xhr, status, error) {
                console.error('Error loading products:', error);
                console.error('Status:', status);
                console.error('Response:', xhr.responseText);
                const tbody = $('#productsTableBody');
                tbody.empty();
                tbody.append('<tr><td colspan="5" class="text-center text-danger">Error loading products. Check console for details.</td></tr>');
            });
        }
        
        // Update pagination
        function updatePagination(data) {
            const pagination = $('#pagination');
            pagination.empty();
            
            // Extract page numbers from URLs
            function getPageNumberFromUrl(url) {
                if (!url) return null;
                const match = url.match(/page=(\d+)/);
                return match ? parseInt(match[1]) : null;
            }
            
            // Calculate current page from next/previous URLs
            const currentPage = data.previous ? (getPageNumberFromUrl(data.previous) + 1) : 1;
            const nextPage = getPageNumberFromUrl(data.next);
            const previousPage = getPageNumberFromUrl(data.previous);
            const totalPages = Math.ceil(data.count / 20); // 20 is the page size
            
            // Add Previous button
            if (previousPage) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${previousPage}">
                            <i class="bi bi-chevron-left"></i> Previous
                        </a>
                    </li>
                `);
            }
            
            // Add page numbers (show up to 10 pages around current page)
            const startPage = Math.max(1, currentPage - 5);
            const endPage = Math.min(totalPages, currentPage + 4);
            
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${activeClass}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `);
            }
            
            // Add Next button
            if (nextPage) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" data-page="${nextPage}">
                            Next <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                `);
            }
            
            // Handle pagination clicks
            pagination.find('a').on('click', function(e) {
                e.preventDefault();
                const page = $(this).data('page');
                console.log('Pagination click - page data attribute:', page);
                // Make sure page is a valid number
                const pageNumber = parseInt(page);
                console.log('Parsed page number:', pageNumber);
                if (pageNumber && !isNaN(pageNumber) && pageNumber > 0) {
                    console.log('Loading page:', pageNumber);
                    loadProducts(pageNumber);
                } else {
                    console.error('Invalid page number:', page);
                    alert('Invalid page number: ' + page);
                }
            });
        }
    });
</script>
{% endblock %}